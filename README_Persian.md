# فانکشن‌بلاک کنترل سرعت خط تولید (FB_LineSpeedControl)

## معرفی پروژه

این پروژه شامل یک فانکشن‌بلاک پیشرفته برای کنترل سرعت خطوط تولید صنعتی است که به زبان **Structured Text** (ST) بر اساس استاندارد **IEC 61131-3** نوشته شده است.

## کاربردهای صنعتی

- **خطوط لمینیت**: کنترل سرعت در تولید ورق‌های چندلایه
- **ماشین‌های چاپ**: تنظیم سرعت خط چاپ بر اساس نوع محصول
- **خطوط بسته‌بندی**: کنترل سرعت نوار نقاله و سیستم‌های بسته‌بندی
- **خطوط تولید نساجی**: تنظیم سرعت ماشین‌آلات بافندگی
- **سیستم‌های حمل‌ونقل**: کنترل نوارهای نقاله

## ویژگی‌های کلیدی

### 🔧 حالت‌های عملکرد
- **حالت دستی (Manual)**: کنترل سرعت با دکمه‌های Up/Down
- **حالت HMI**: تنظیم سرعت از رابط کاربری
- **حالت اتوماتیک (Auto)**: کنترل سرعت از سیستم‌های بالاتر

### 🚨 سیستم ایمنی
- **توقف اضطراری**: کاهش سریع سرعت با رمپ ایمن
- **قفل ایمنی**: جلوگیری از راه‌اندازی پس از توقف اضطراری
- **محدودیت سرعت**: حداقل و حداکثر سرعت قابل تنظیم

### ⚡ کنترل پیشرفته
- **رمپ نرم**: تغییر تدریجی سرعت برای محافظت از تجهیزات
- **تقسیم امن**: جلوگیری از خطای تقسیم بر صفر
- **زمان‌های قابل تنظیم**: رمپ‌های مختلف برای حالت‌های مختلف

## ساختار فایل‌ها

```
├── FB_LineSpeedControl.st   # فانکشن‌بلاک اصلی
├── Example_Usage.st         # مثال استفاده
└── README_Persian.md        # این فایل توضیحات
```

## پارامترهای ورودی

| پارامتر | نوع | توضیحات | مقدار پیش‌فرض |
|---------|-----|---------|---------------|
| `enable` | BOOL | فعال‌سازی فانکشن‌بلاک | - |
| `mode` | INT | حالت کار (0=Manual, 1=HMI, 2=Auto) | - |
| `setpointHMI` | REAL | نقطه تنظیم از HMI (m/min) | - |
| `autoSetpoint` | REAL | نقطه تنظیم اتوماتیک (m/min) | - |
| `speedUp` | BOOL | دکمه افزایش سرعت دستی | - |
| `speedDown` | BOOL | دکمه کاهش سرعت دستی | - |
| `stopEmergency` | BOOL | توقف اضطراری | - |
| `maxSpeed` | REAL | حداکثر سرعت مجاز (m/min) | 100.0 |
| `minSpeed` | REAL | حداقل سرعت مجاز (m/min) | 0.0 |
| `rampUpTimeNormal_s` | REAL | زمان رمپ عادی (ثانیه) | 5.0 |
| `rampDownTimeEmergency_s` | REAL | زمان رمپ توقف اضطراری (ثانیه) | 2.0 |
| `manualRampTime_s` | REAL | زمان رمپ حالت دستی (ثانیه) | 1.0 |
| `rampStep` | REAL | قدم تغییر سرعت دستی (m/min) | 1.0 |
| `scanCycle_ms` | REAL | زمان چرخه اسکن (میلی‌ثانیه) | 10.0 |

## پارامترهای خروجی

| پارامتر | نوع | توضیحات |
|---------|-----|---------|
| `speedOut_mpm` | REAL | سرعت خروجی (m/min) |
| `emergencyLatched` | BOOL | وضعیت قفل توقف اضطراری |

## نحوه استفاده

### 1. اعلان Instance

```pascal
VAR
    lineSpeedController : FB_LineSpeedControl;
END_VAR
```

### 2. فراخوانی فانکشن‌بلاک

```pascal
lineSpeedController(
    enable := TRUE,
    mode := 1,
    setpointHMI := 50.0,
    // سایر پارامترها...
    speedOut_mpm => outputSpeed
);
```

## الگوریتم کارکرد

### 1. بررسی فعال‌سازی
- اگر `enable = FALSE` باشد، خروجی به صفر می‌رسد

### 2. مدیریت توقف اضطراری
- در صورت فعال شدن `stopEmergency`، سرعت با رمپ سریع کاهش می‌یابد
- پس از رسیدن به صفر، سیستم قفل می‌شود

### 3. انتخاب حالت کار
- **Manual (0)**: کنترل با دکمه‌های Up/Down
- **HMI (1)**: استفاده از `setpointHMI`
- **Auto (2)**: استفاده از `autoSetpoint`

### 4. اعمال رمپ نرم
- محاسبه تفاوت بین سرعت فعلی و هدف
- اعمال تدریجی تغییرات با رمپ مناسب

### 5. محدودسازی
- اعمال حداقل و حداکثر سرعت

## تابع SafeDivide

```pascal
FUNCTION SafeDivide : REAL
// جلوگیری از خطای تقسیم بر صفر
IF ABS(denominator) < 0.0001 THEN
    SafeDivide := 0.0;
ELSE
    SafeDivide := numerator / denominator;
END_IF;
```

## نکات ایمنی

⚠️ **هشدارهای مهم:**

1. **تنظیم زمان رمپ**: زمان‌های رمپ باید متناسب با اینرسی سیستم تنظیم شوند
2. **حداکثر سرعت**: مقدار `maxSpeed` نباید از حد مجاز مکانیکی تجهیزات تجاوز کند
3. **توقف اضطراری**: سیستم توقف اضطراری باید مستقل از PLC نیز قابل اجرا باشد
4. **زمان چرخه**: `scanCycle_ms` باید با زمان واقعی چرخه PLC مطابقت داشته باشد

## مثال پیکربندی برای کاربردهای مختلف

### خط لمینیت
```pascal
maxSpeed := 200.0;              // m/min
rampUpTimeNormal_s := 15.0;     // رمپ آهسته برای لمینیت
rampDownTimeEmergency_s := 5.0; // توقف نسبتاً آهسته
```

### خط بسته‌بندی
```pascal
maxSpeed := 80.0;               // m/min
rampUpTimeNormal_s := 3.0;      // رمپ سریع
rampDownTimeEmergency_s := 1.0; // توقف سریع
```

### خط چاپ
```pascal
maxSpeed := 150.0;              // m/min
rampUpTimeNormal_s := 8.0;      // رمپ متوسط
rampDownTimeEmergency_s := 2.0; // توقف سریع برای جلوگیری از ضایعات
```

## تست و اشکال‌زدایی

### بررسی عملکرد صحیح
1. تست تغییر حالت‌های Manual/HMI/Auto
2. تست توقف اضطراری و قفل شدن سیستم
3. بررسی محدودیت‌های حداقل/حداکثر سرعت
4. تست رمپ‌های مختلف

### مشکلات رایج
- **سرعت ثابت نمی‌ماند**: بررسی مقدار `scanCycle_ms`
- **رمپ خیلی سریع**: افزایش زمان رمپ
- **عدم پاسخ به دکمه‌ها**: بررسی حالت Manual

## مجوز و حقوق نشر

این کد برای استفاده در پروژه‌های صنعتی آزاد است.
تاریخ: ۲۰۲۵/۰۷/۰۲

---

**نویسنده**: AI Assistant  
**زبان برنامه‌نویسی**: IEC 61131-3 Structured Text  
**مناسب برای**: Siemens, Allen-Bradley, Schneider, و سایر PLCهای استاندارد