# فانکشن‌بلاک کنترل سرعت خط تولید (FB_LineSpeedControl)

## معرفی پروژه - نسخه 2.0 بهینه‌سازی شده

این پروژه شامل یک فانکشن‌بلاک پیشرفته و بهینه‌سازی شده برای کنترل دقیق سرعت خطوط تولید صنعتی است که به زبان **Structured Text** (ST) بر اساس استاندارد **IEC 61131-3** نوشته شده است.

### ✨ ویژگی‌های جدید در نسخه 2.0

- **کامنت‌های دوزبانه کامل**: تمام بخش‌های کد دارای توضیحات فارسی و انگلیسی
- **قابلیت ریست خطاها**: دکمه ریست برای رفع قفل‌های اضطراری
- **حرکت آهسته (Jog)**: امکان حرکت آهسته رو به جلو و عقب
- **اینترلاک ایمنی**: بررسی شرایط ایمنی قبل از راه‌اندازی
- **محاسبه شتاب لحظه‌ای**: نمایش شتاب/کاهش سرعت بر حسب m/s²
- **شمارنده زمان کارکرد**: ثبت ساعات کارکرد خط
- **محاسبه مسافت طی شده**: ثبت کیلومترهای طی شده
- **نمایش درصد سرعت**: نمایش سرعت به صورت درصدی از حداکثر
- **هشدار سرعت بالا**: آلارم برای سرعت‌های نزدیک به حداکثر
- **نمایش حالت فعلی**: نمایش متنی حالت عملیاتی
- **محافظت بهبود یافته**: استفاده از تابع LIMIT برای محدودسازی
- **پشتیبانی از انواع محصول**: تنظیمات مختلف برای محصولات متفاوت

## کاربردهای صنعتی

- **خطوط لمینیت**: کنترل سرعت در تولید ورق‌های چندلایه
- **ماشین‌های چاپ**: تنظیم سرعت خط چاپ بر اساس نوع محصول
- **خطوط بسته‌بندی**: کنترل سرعت نوار نقاله و سیستم‌های بسته‌بندی
- **خطوط تولید نساجی**: تنظیم سرعت ماشین‌آلات بافندگی
- **سیستم‌های حمل‌ونقل**: کنترل نوارهای نقاله

## ساختار فایل‌ها

```
├── FB_LineSpeedControl.st   # فانکشن‌بلاک اصلی (بهینه‌سازی شده)
├── Example_Usage.st         # مثال استفاده (گسترش یافته)
└── README_Persian.md        # این فایل توضیحات
```

## پارامترهای ورودی جدید

### پارامترهای کنترل اصلی

| پارامتر | نوع | توضیحات | مقدار پیش‌فرض |
|---------|-----|---------|---------------|
| `enable` | BOOL | فعال‌سازی فانکشن‌بلاک | - |
| `reset` | BOOL | **جدید** - ریست خطاها و قفل‌ها | - |
| `mode` | INT | حالت کار (0=Manual, 1=HMI, 2=Auto) | - |

### پارامترهای کنترل دستی

| پارامتر | نوع | توضیحات | مقدار پیش‌فرض |
|---------|-----|---------|---------------|
| `speedUp` | BOOL | دکمه افزایش سرعت دستی | - |
| `speedDown` | BOOL | دکمه کاهش سرعت دستی | - |
| `jogForward` | BOOL | **جدید** - حرکت آهسته رو به جلو | - |
| `jogReverse` | BOOL | **جدید** - حرکت آهسته رو به عقب | - |

### پارامترهای ایمنی

| پارامتر | نوع | توضیحات | مقدار پیش‌فرض |
|---------|-----|---------|---------------|
| `stopEmergency` | BOOL | توقف اضطراری | - |
| `safetyInterlockOK` | BOOL | **جدید** - اینترلاک ایمنی | TRUE |

### پارامترهای محدودیت و تنظیمات

| پارامتر | نوع | توضیحات | مقدار پیش‌فرض |
|---------|-----|---------|---------------|
| `jogSpeed` | REAL | **جدید** - سرعت حرکت آهسته (m/min) | 5.0 |
| `rampDownTimeNormal_s` | REAL | **جدید** - زمان کاهش سرعت عادی (s) | 5.0 |
| `speedTolerance` | REAL | **جدید** - تلرانس سرعت (m/min) | 0.5 |
| `warningThreshold` | REAL | **جدید** - آستانه هشدار سرعت (%) | 90.0 |

## پارامترهای خروجی جدید

### خروجی‌های اصلی

| پارامتر | نوع | توضیحات |
|---------|-----|---------|
| `speedOut_mpm` | REAL | سرعت خروجی (m/min) |
| `speedOut_percent` | REAL | **جدید** - سرعت خروجی درصدی (%) |
| `acceleration_mps2` | REAL | **جدید** - شتاب لحظه‌ای (m/s²) |

### وضعیت‌ها

| پارامتر | نوع | توضیحات |
|---------|-----|---------|
| `isRunning` | BOOL | **جدید** - در حال کار |
| `atSetpoint` | BOOL | **جدید** - رسیدن به نقطه تنظیم |
| `emergencyLatched` | BOOL | قفل توقف اضطراری |

### هشدارها و اطلاعات تشخیصی

| پارامتر | نوع | توضیحات |
|---------|-----|---------|
| `speedWarning` | BOOL | **جدید** - هشدار سرعت بالا |
| `rampActive` | BOOL | **جدید** - رمپ فعال است |
| `currentMode` | STRING[20] | **جدید** - نمایش حالت فعلی |
| `runTime_hours` | REAL | **جدید** - زمان کارکرد (ساعت) |
| `totalDistance_km` | REAL | **جدید** - مسافت کل طی شده (km) |

## الگوریتم بهبود یافته

### 1. مقداردهی اولیه
- تنظیم مقادیر اولیه در اولین اسکن
- آماده‌سازی شمارنده‌ها و تایمرها

### 2. مدیریت ریست
- امکان ریست قفل توقف اضطراری
- پاک کردن خطاها با دکمه ریست

### 3. بررسی ایمنی پیشرفته
- بررسی enable و اینترلاک ایمنی
- کاهش تدریجی سرعت در صورت غیرفعال شدن

### 4. مدیریت توقف اضطراری بهبود یافته
- ذخیره سرعت قبل از توقف
- کاهش سریع با رمپ اضطراری
- قفل شدن پس از توقف کامل

### 5. قابلیت حرکت آهسته (Jog)
- حرکت آهسته رو به جلو با `jogForward`
- حرکت آهسته رو به عقب با `jogReverse`
- مدیریت تداخل دو دکمه

### 6. انتخاب حالت هوشمند
- تشخیص تغییر حالت
- تغییر خودکار به حالت دستی با فشردن دکمه‌ها
- استفاده از CASE برای مدیریت بهتر

### 7. محاسبات رمپ پیشرفته
- رمپ‌های جداگانه برای افزایش و کاهش سرعت
- استفاده از تلرانس برای جلوگیری از نوسان
- محاسبه نرخ واقعی رمپ

### 8. محاسبات خروجی جامع
- محاسبه درصد سرعت
- محاسبه شتاب لحظه‌ای
- تنظیم فلگ‌های وضعیت
- محاسبه زمان کارکرد و مسافت

## مثال استفاده پیشرفته

### تنظیم بر اساس نوع محصول

```pascal
CASE productType OF
    1:  // محصول نوع 1 - سرعت پایین
        maxLineSpeed := 60.0;
        normalRampUp := 5.0;
        
    2:  // محصول نوع 2 - سرعت متوسط
        maxLineSpeed := 100.0;
        normalRampUp := 8.0;
        
    3:  // محصول نوع 3 - سرعت بالا
        maxLineSpeed := 150.0;
        normalRampUp := 12.0;
END_CASE;
```

### محاسبه اینترلاک ایمنی

```pascal
safetyInterlock := safetyGatesClosed AND motorTempOK AND NOT maintenanceMode;
```

### نمایش اطلاعات در HMI

```
سرعت فعلی: 75.5 m/min (62.9%)
شتاب: 1.2 m/s²
حالت: AUTOMATIC
وضعیت: در حال کار
زمان کارکرد: 1250.5 ساعت
مسافت: 5420.8 km
```

## نکات بهینه‌سازی

### 🚀 بهبود عملکرد
1. استفاده از LIMIT به جای IF های تو در تو
2. محاسبات فقط در صورت نیاز
3. استفاده از ثابت‌ها برای مقادیر تکراری

### 🔧 قابلیت نگهداری
1. کامنت‌های دوزبانه کامل
2. ساختار منطقی و واضح
3. نام‌گذاری استاندارد متغیرها

### 🛡️ ایمنی
1. بررسی‌های چندگانه ایمنی
2. مدیریت حالت‌های غیرمنتظره
3. محافظت از تقسیم بر صفر

## تست و اشکال‌زدایی

### سناریوهای تست
1. **تست حرکت آهسته**: بررسی عملکرد دکمه‌های Jog
2. **تست ریست**: بررسی رفع قفل اضطراری
3. **تست تغییر محصول**: بررسی تنظیمات مختلف
4. **تست اینترلاک**: بررسی عملکرد ایمنی

### ابزارهای تشخیصی
- مشاهده `currentMode` برای وضعیت فعلی
- بررسی `acceleration_mps2` برای نرمی حرکت
- کنترل `runTime_hours` برای نگهداری پیشگیرانه

## سازگاری

این کد با تمام PLCهای استاندارد IEC 61131-3 سازگار است:
- ✅ Siemens (TIA Portal)
- ✅ Allen-Bradley (Studio 5000)
- ✅ Schneider (EcoStruxure)
- ✅ ABB (Automation Builder)
- ✅ Beckhoff (TwinCAT)
- ✅ CODESYS based PLCs

## نسخه‌های آینده

### برنامه‌ریزی شده برای نسخه 3.0
- [ ] پشتیبانی از چند موتور همزمان
- [ ] الگوریتم یادگیری برای بهینه‌سازی رمپ
- [ ] ارتباط با سیستم MES
- [ ] ذخیره پروفایل‌های سرعت
- [ ] گزارش‌گیری خودکار

## مجوز و حقوق نشر

این کد برای استفاده در پروژه‌های صنعتی آزاد است.  
نسخه: 2.0 (بهینه‌سازی شده)  
تاریخ: ۱۴۰۳/۱۰/۱۸ (2025/01/07)

---

**توسعه‌دهنده**: AI Assistant  
**زبان برنامه‌نویسی**: IEC 61131-3 Structured Text  
**مناسب برای**: تمام PLCهای صنعتی استاندارد